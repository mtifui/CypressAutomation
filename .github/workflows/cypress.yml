# .github/workflows/e2e-trcli.yml
name: e2e + TestRail

on:
  push:
  pull_request:

jobs:
  cypress-trcli:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      # âœ… Either keep this (after you commit the updated lockfile) ...
      - name: Install deps
        run: npm ci
      # ...or temporarily use:
      # - name: Install deps
      #   run: npm ci || npm install --no-audit --no-fund

      - name: Run Cypress (JUnit only)
        run: npm run cypress:run
        env:
          CYPRESS_video: "false"
          CYPRESS_screenshotOnRunFailure: "false"

      - name: Upload JUnit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-${{ github.run_number }}
          path: cypress/reports/results-*.xml
          retention-days: 14

      - name: Setup Python (for TRCLI)
        if: always()
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install TRCLI
        if: always()
        run: pip install --upgrade pip trcli

      - name: Summarize tests in job summary
        if: always()
        uses: test-summary/action@v2
        with:
          paths: "cypress/reports/results-*.xml"

      - name: Annotate PR with JUnit details
        if: always()
        uses: mikepenz/action-junit-report@v5
        with:
          report_paths: "cypress/reports/results-*.xml"
        commit: ${{ github.sha }}

      - name: Upload results to TestRail
        if: always()
        env:
          TESTRAIL_USER: ${{ secrets.TESTRAIL_USER }}
          TESTRAIL_PASS: ${{ secrets.TESTRAIL_PASS }}
        run: |
          # Guard: skip TRCLI gracefully if no JUnit files (e.g. install failed)
          shopt -s nullglob
          files=(cypress/reports/results-*.xml)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No JUnit XML found; skipping TRCLI upload."
            exit 0
          fi

          trcli -y -c trcli-config.yml \
            -h "https://endavatesttool.testrail.io" \
            --project "TestCaseCreation" \
            --username "$TESTRAIL_USER" \
            --password "$TESTRAIL_PASS" \
            parse_junit \
            --title "Cypress E2E #${{ github.run_number }} (ref: ${{ github.ref_name }})" \
            --run-description "GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            -f "cypress/reports/results-*.xml" \
            --close-run

     
    
