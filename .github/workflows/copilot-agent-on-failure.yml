name: Create Copilot Agent task

on:
  workflow_run:
    workflows: ["e2e + TestRail"]   # must match your CI workflow's 'name'
    types: [completed]

jobs:
  delegate:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        uses: cli/cli-action@v2

      - name: Auth GH CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Ask Copilot to analyze and propose a fix
        env:
          RUN_ID: ${{ github.event.workflow_run.id }}
          REPO: ${{ github.repository }}
        run: |
          gh agent-task create "
          Analyze the latest failed workflow run (ID: ${RUN_ID}) for ${REPO}.
          Goals:
          - Download artifacts, read JUnit XML: cypress/reports/results-*.xml
          - Cluster failures by spec and test title; identify root cause(s)
          - Reproduce locally in your environment (npm ci; npm run cypress:run)
          - Implement the smallest safe fix in code/tests
          - Open a **draft** PR from branch 'fix/agent-${RUN_ID}' with:
            * RCA summary
            * Files changed and rationale
            * How I reproduced & how to run locally
          Constraints: follow .github/copilot-instructions.md; no new secrets or external services."
